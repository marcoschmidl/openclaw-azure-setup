# ==========================================================
# Nginx Reverse Proxy Configuration
# ==========================================================
# Proxies HTTPS traffic to the OpenClaw container (port 18789).
# Provides SSL termination and Basic Auth protection.
#
# This file is a Terraform template. Variables:
#   ${fqdn}  â€” Public FQDN of the VM
#
# SSL certificate is self-signed (generated by cloud-init).
# Basic Auth credentials are set by start.sh from Key Vault.
# ==========================================================

# -- HTTPS Server (primary) --
server {
    listen 443 ssl;
    server_name ${fqdn};

    # SSL configuration (self-signed certificate)
    ssl_certificate     /etc/nginx/ssl/openclaw.crt;
    ssl_certificate_key /etc/nginx/ssl/openclaw.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # Basic Auth protection (credentials from Key Vault via start.sh)
    auth_basic           "OpenClaw Dashboard";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # Proxy all traffic to the OpenClaw container
    location / {
        proxy_pass         http://openclaw:18789;
        proxy_http_version 1.1;

        # WebSocket support (required for live terminal sessions)
        proxy_set_header   Upgrade $$http_upgrade;
        proxy_set_header   Connection "upgrade";

        # Forward original client information
        proxy_set_header   Host $$host;
        proxy_set_header   X-Real-IP $$remote_addr;
        proxy_set_header   X-Forwarded-For $$proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $$scheme;

        # Long timeout for WebSocket connections (24h)
        proxy_read_timeout 86400;
    }
}

# -- HTTP Server (redirect to HTTPS) --
server {
    listen 80;
    server_name ${fqdn};

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$$host$$request_uri;
}
