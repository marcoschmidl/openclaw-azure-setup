# ==========================================================
# OpenClaw Docker Compose Configuration
# ==========================================================
# Runs the Nginx reverse proxy container for SSL termination
# and Basic Auth. OpenClaw itself runs as a host process
# (systemd service) and is accessed via host.docker.internal.
#
# Nginx forwards HTTPS traffic to the OpenClaw host process
# on port 18789. Secrets are loaded from .env (written by
# start.sh from Key Vault).
# ==========================================================

services:
  # -- Nginx Reverse Proxy --
  # Handles SSL termination, Basic Auth, and proxying to the
  # OpenClaw host process on port 18789.
  # Listens on ports 443 (HTTPS) and 80 (redirects to HTTPS).
  nginx:
    image: nginx:alpine
    container_name: openclaw-nginx
    restart: unless-stopped
    ports:
      - "443:443"   # HTTPS (self-signed cert)
      - "80:80"     # HTTP (redirects to HTTPS)
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro  # Nginx config
      - ./nginx/ssl:/etc/nginx/ssl:ro                            # SSL cert + key
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro                # Basic Auth credentials
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access host process from container
    # Security hardening
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m
      - /var/cache/nginx:noexec,nosuid,size=10m
      - /var/run:noexec,nosuid,size=1m
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE   # Required for binding to ports 80/443
      - DAC_READ_SEARCH    # Required for reading SSL key files
      - CHOWN              # Required for nginx cache dir ownership
      - SETUID             # Required for nginx to drop to worker user
      - SETGID             # Required for nginx to drop to worker group
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.5"
