# ==========================================================
# OpenClaw Docker Compose Configuration
# ==========================================================
# Runs two containers:
#   1. nginx   — Reverse proxy with SSL termination + Basic Auth
#   2. openclaw — The OpenClaw GitHub agent
#
# Nginx forwards HTTPS traffic to OpenClaw's internal port 18789.
# Secrets are loaded from .env (written by start.sh from Key Vault).
# ==========================================================

services:
  # -- Nginx Reverse Proxy --
  # Handles SSL termination, Basic Auth, and proxying to OpenClaw.
  # Listens on ports 443 (HTTPS) and 80 (redirects to HTTPS).
  nginx:
    image: nginx:alpine
    container_name: openclaw-nginx
    restart: unless-stopped
    ports:
      - "443:443"   # HTTPS (self-signed cert)
      - "80:80"     # HTTP (redirects to HTTPS)
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro  # Nginx config
      - ./nginx/ssl:/etc/nginx/ssl:ro                            # SSL cert + key
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro                # Basic Auth credentials
    depends_on:
      openclaw:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.5"

  # -- OpenClaw GitHub Agent --
  # Runs the OpenClaw agent that interacts with GitHub repositories.
  # Exposes port 18789 internally (only accessible via Nginx proxy).
  openclaw:
    image: openclaw/openclaw:latest
    container_name: openclaw-github-agent
    restart: unless-stopped
    volumes:
      - ./config:/home/openclaw/.openclaw         # Agent configuration
      - ./workspace:/home/openclaw/workspace      # Cloned repositories
    env_file:
      - .env  # Contains GITHUB_TOKEN, ANTHROPIC_API_KEY (written by start.sh)
    environment:
      - GIT_AUTHOR_NAME=openclaw-bot
      - GIT_AUTHOR_EMAIL=openclaw-bot@noreply.github.com
      - GIT_COMMITTER_NAME=openclaw-bot
      - GIT_COMMITTER_EMAIL=openclaw-bot@noreply.github.com
      - OPENCLAW_HOME=/home/openclaw/.openclaw
    expose:
      - "18789"  # Internal port (not exposed to host, only to Nginx)
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:18789/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    # Security hardening
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    tmpfs:
      - /tmp:size=256M          # Writable tmpfs for temporary files
