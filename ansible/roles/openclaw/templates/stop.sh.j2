#!/bin/bash
set -euo pipefail

# ==========================================================
# OpenClaw — Stop Script
# ==========================================================
# Rendered by Ansible — do not edit manually on the VM.
#
# Stops the OpenClaw systemd service and the Nginx Docker
# container. Removes the local .env file containing secrets
# (secrets remain safe in Key Vault).
#
# Usage:
#   cd ~/openclaw && ./stop.sh
# ==========================================================

# -- Logging helpers --
log()  { echo -e "\033[0;32m[stop.sh] $1\033[0m"; }
warn() { echo -e "\033[1;33m[stop.sh] WARN: $1\033[0m"; }

WORK_DIR="$(cd "$(dirname "$0")" && pwd)"

log "Stopping OpenClaw..."
log "  Working directory: $WORK_DIR"
echo ""

# -- Step 1: Show current status --
log "Current status:"
echo "  OpenClaw service: $(systemctl is-active openclaw 2>/dev/null || echo 'inactive')"
cd "$WORK_DIR"
docker compose ps 2>/dev/null || true
echo ""

# -- Step 2: Stop OpenClaw systemd service --
log "Stopping OpenClaw service (systemd)..."
sudo systemctl stop openclaw 2>/dev/null || true
log "  OpenClaw service stopped"

# -- Step 3: Stop and remove Nginx container --
log "Stopping Nginx container (Docker)..."
docker compose down
log "  Nginx container stopped and removed"

# -- Step 4: Clean up local secrets (secure deletion) --
if [ -f "$WORK_DIR/.env" ]; then
    if command -v shred &>/dev/null; then
        shred -u "$WORK_DIR/.env"
    else
        rm -f "$WORK_DIR/.env"
    fi
    log "  Removed .env file (secrets cleaned up)"
else
    log "  No .env file found (already clean)"
fi

# -- Step 5: Clean up htpasswd (secure deletion) --
if [ -f "$WORK_DIR/nginx/.htpasswd" ]; then
    if command -v shred &>/dev/null; then
        shred -u "$WORK_DIR/nginx/.htpasswd"
    else
        rm -f "$WORK_DIR/nginx/.htpasswd"
    fi
    log "  Removed htpasswd file"
fi

# -- Done --
echo ""
log "OpenClaw stopped. Secrets removed from disk."
log "  Secrets remain safe in Azure Key Vault."
log "  Run ./start.sh to restart."
echo ""
